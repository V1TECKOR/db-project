{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h2 class="mb-1">{{ team_name }} vs {{ match.opponent }}</h2>
    <div class="text-muted">
      Location: {{ match.location }} â€¢ Status: {{ match.status }}
      {% if match.final_date %} â€¢ Final: {{ match.final_date }}{% endif %}
    </div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ back_url }}">Back</a>
    {% if is_captain %}
      <a class="btn btn-outline-primary" href="{{ url_for('match_edit', match_id=match.id) }}">Edit Match</a>
    {% endif %}
  </div>
</div>

<!-- Availability -->
<div class="card mb-3">
  <h5 class="mb-3">Availability</h5>

  {% if date_options %}
    <form method="post" action="{{ url_for('match_availability') }}">
      <input type="hidden" name="match_id" value="{{ match.id }}">

      <div class="row g-2">
        {% for d in date_options %}
          <div class="col-md-4">
            <label class="p-3 d-block"
                   style="border:1px solid rgba(255,255,255,.08); border-radius: 14px; cursor:pointer;">
              <input type="checkbox" name="date_ids" value="{{ d.id }}"
                     {% if d.id in my_date_ids %}checked{% endif %}>
              <span class="ms-2">{{ d.proposed_datetime }}</span>
            </label>
          </div>
        {% endfor %}
      </div>

      <button class="btn btn-primary mt-3">Save Availability</button>
    </form>

    {% if is_captain and match.status == "planned" %}
      <hr style="border-color: rgba(255,255,255,.08);">

      <h6 class="text-muted mb-2">Captain Summary (who is available)</h6>
      {% for s in date_summaries %}
        <div class="p-3 mb-2"
             style="border:1px solid rgba(255,255,255,.08); border-radius: 14px;">
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div>
              <div class="fw-semibold">{{ s.proposed_datetime }}</div>
              <div class="text-muted small">{{ s.count }} available â€¢ {{ s.names }}</div>
            </div>

            <form method="post" action="{{ url_for('match_confirm_date') }}">
              <input type="hidden" name="match_id" value="{{ match.id }}">
              <input type="hidden" name="date_id" value="{{ s.id }}">
              <button class="btn btn-sm btn-outline-primary">Confirm this date</button>
            </form>
          </div>
        </div>
      {% endfor %}
    {% endif %}

  {% else %}
    <div class="text-muted">No proposed dates yet.</div>
  {% endif %}
</div>

<!-- Lineup -->
<div class="card mb-3">
  <h5 class="mb-3">Lineup</h5>

  {% if is_captain %}
    <form method="post" action="{{ url_for('match_set_lineup') }}">
      <input type="hidden" name="match_id" value="{{ match.id }}">

      <div class="row g-2">
        {% for m in members %}
          <div class="col-md-4">
            <label class="p-3 d-block"
                   style="border:1px solid rgba(255,255,255,.08); border-radius: 14px; cursor:pointer;">
              <input type="checkbox" name="player_ids" value="{{ m.id }}"
                     {% if m.id in lineup_ids %}checked{% endif %}>
              <span class="ms-2">{{ m.first_name }} {{ m.last_name }}</span>
            </label>
          </div>
        {% endfor %}
      </div>

      <button class="btn btn-primary mt-3">Save Lineup</button>
    </form>

    {% if lineup_status %}
      <hr style="border-color: rgba(255,255,255,.08);">
      <h6 class="text-muted mb-2">Confirmations</h6>
      {% for ls in lineup_status %}
        <div class="d-flex justify-content-between p-2"
             style="border-bottom:1px solid rgba(255,255,255,.08);">
          <div>{{ ls.name }}</div>
          <div class="{% if ls.confirmed %}text-success{% else %}text-muted{% endif %}">
            {% if ls.confirmed %}Confirmed{% else %}Pending{% endif %}
          </div>
        </div>
      {% endfor %}
    {% endif %}

  {% else %}
    {% if in_lineup %}
      <div class="mb-2">
        You are selected in the lineup.
        {% if confirmed %}
          <span class="text-success fw-semibold">Confirmed âœ…</span>
        {% else %}
          <span class="text-muted">Not confirmed yet</span>
        {% endif %}
      </div>

      <form method="post" action="{{ url_for('match_confirm_lineup') }}" class="d-flex gap-2">
        <input type="hidden" name="match_id" value="{{ match.id }}">
        <button class="btn btn-primary" name="response" value="yes">I can play</button>
        <button class="btn btn-outline-danger" name="response" value="no">I canâ€™t play</button>
      </form>
    {% else %}
      <div class="text-muted">Captain has not selected lineup yet (or you are not selected).</div>
    {% endif %}
  {% endif %}
</div>

<!-- Volunteers -->
<div class="card mb-3">
  <h5 class="mb-3">Volunteers (first come, first served)</h5>

  <div class="row g-2">
    {% for task in tasks %}
      <div class="col-md-4">
        <div class="p-3"
             style="border:1px solid rgba(255,255,255,.08); border-radius:14px;">
          <div class="fw-semibold">{{ task }}</div>
          <div class="text-muted mb-2">
            {% if task_assignments.get(task) %}
              Taken by: <strong>{{ task_assignments.get(task) }}</strong>
            {% else %}
              Free â€” be the first ðŸ™‚
            {% endif %}
          </div>

          {% if not task_assignments.get(task) %}
            <form method="post" action="{{ url_for('match_task') }}">
              <input type="hidden" name="match_id" value="{{ match.id }}">
              <input type="hidden" name="task" value="{{ task }}">
              <button class="btn btn-primary btn-sm w-100">I take {{ task }}</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Messages -->
<div class="card mb-3">
  <h5 class="mb-3">Messages</h5>

  <form method="post" action="{{ url_for('match_message') }}" class="mb-3">
    <input type="hidden" name="match_id" value="{{ match.id }}">
    <div class="input-group">
      <input class="form-control" name="content" placeholder="Write a messageâ€¦" required>
      <button class="btn btn-primary">Send</button>
    </div>
  </form>

  <div style="max-height: 360px; overflow:auto;">
    {% if messages %}
      {% for msg in messages %}
        <div class="mb-2 p-2" style="border-bottom:1px solid rgba(255,255,255,.08);">
          <div class="small text-muted">{{ msg.created_at }} â€¢ {{ msg.author }}</div>
          <div>{{ msg.content }}</div>
        </div>
      {% endfor %}
    {% else %}
      <div class="text-muted">No messages yet.</div>
    {% endif %}
  </div>
</div>

{% endblock %}
